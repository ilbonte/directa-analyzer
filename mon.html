<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Portafoglio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.0/chart.umd.min.js"></script>
</head>
<body>
<div class="container mt-4">
    <h1>Analisi Portafoglio</h1>

    <!-- File Input -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Carica CSV</h5>
            <input type="file" class="form-control" id="csvFile" accept=".csv">
        </div>
    </div>

    <!-- Results Section -->
    <div id="results" style="display:none;">
        <!-- Overall Stats -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Statistiche Totali</h5>
                    </div>
                    <div class="card-body">
                        <div id="totalStats"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Statistiche Aggiuntive</h5>
                    </div>
                    <div class="card-body">
                        <div id="additionalStats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Statistiche Annuali</h5>
            </div>
            <div class="card-body">
                <div id="yearlyStats"></div>
            </div>
        </div>

        <!-- Cumulative Gain/Loss Chart -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Gain/Loss Cumulativo</h5>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 60vh; width: 100%">
                    <canvas id="gainLossChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    let chart = null;

    function parseItalianNumber(str) {
        if (!str) return 0;
        return parseFloat(str.replace(',', '.'));
    }

    function parseCSV(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function (event) {
                const csv = event.target.result;
                const lines = csv.split('\n');

                const portfolioData = [];
                const movimentiData = [];

                lines.slice(6).forEach(line => {
                    const columns = line.split(',');

                    if (columns[0] && columns[0].trim().match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                        portfolioData.push({
                            date: columns[0].trim(),
                            liquidita: parseItalianNumber(columns[1]),
                            patrimonio: parseItalianNumber(columns[6])
                        });
                    }

                    if (columns[8] && columns[8].trim().match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                        movimentiData.push({
                            date: columns[8].trim(),
                            value: parseItalianNumber(columns[10])
                        });
                    }
                });

                resolve({
                    portfolioData: portfolioData,
                    movimentiData: movimentiData
                });
            };
            reader.readAsText(file);
        });
    }

    function alignMovementDates(portfolioData, movimentiData) {
        const windowDays = 3;
        const alignedMovements = [];

        movimentiData.forEach(movement => {
            const movementDate = new Date(movement.date.split('/').reverse().join('-'));
            const movementValue = movement.value;
            let foundMatch = false;

            for (let i = 0; i < portfolioData.length - 1; i++) {
                const currDate = new Date(portfolioData[i].date.split('/').reverse().join('-'));
                const nextDate = new Date(portfolioData[i + 1].date.split('/').reverse().join('-'));

                // Check if current portfolio date is within window of movement date
                const daysDiff = Math.abs((currDate - movementDate) / (1000 * 60 * 60 * 24));

                if (daysDiff <= windowDays) {
                    const currLiq = portfolioData[i].liquidita;
                    const nextLiq = portfolioData[i + 1].liquidita;
                    const liquidityChange = nextLiq - currLiq;

                    // Check if liquidity change matches movement value (with small tolerance)
                    const tolerance = 0.01;
                    if (Math.abs(liquidityChange - movementValue) <= tolerance) {
                        alignedMovements.push({
                            date: portfolioData[i + 1].date,
                            value: movementValue,
                            originalDate: movement.date
                        });
                        foundMatch = true;
                        break;
                    }
                }
            }

            if (!foundMatch) {
                console.log(`Warning: No matching liquidity change found for movement on ${movement.date} of ${movementValue.toFixed(2)}€`);
            }
        });

        return alignedMovements;
    }

    function calculateStats(portfolioData, alignedMovements) {
        let cumulativeGainLoss = 0;
        const dailyGains = [];
        let previousPatrimonio = null;

        portfolioData.forEach((day, index) => {
            if (previousPatrimonio !== null) {
                const currentPatrimonio = day.patrimonio;
                const movimentiGiorno = alignedMovements
                    .filter(m => m.date === day.date)
                    .reduce((sum, m) => sum + m.value, 0);

                const diffPatrimonio = currentPatrimonio - previousPatrimonio;
                const gainLoss = diffPatrimonio - movimentiGiorno;

                cumulativeGainLoss += gainLoss;

                dailyGains.push({
                    date: day.date,
                    gainLoss: gainLoss,
                    gainLossPerc: previousPatrimonio !== 0 ? (gainLoss / previousPatrimonio) * 100 : 0,
                    cumulativeGainLoss: cumulativeGainLoss
                });
            }
            previousPatrimonio = day.patrimonio;
        });

        return {
            dailyGains,
            totalGainLoss: cumulativeGainLoss,
            patrimonyInitial: portfolioData[0].patrimonio,
            patrimonyFinal: portfolioData[portfolioData.length - 1].patrimonio,
            totalMovements: alignedMovements.reduce((sum, m) => sum + m.value, 0)
        };
    }


    function updateChart(dailyGains) {
        if (chart) {
            chart.destroy();
        }

        const ctx = document.getElementById('gainLossChart');
        console.log('googo');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyGains.map(day => day.date),
                datasets: [{
                    label: 'Gain/Loss Cumulativo',
                    data: dailyGains.map(day => day.cumulativeGainLoss),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                pointStyle: 'false',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function displayResults(stats) {
        const rendimentoTotale = ((stats.patrimonyFinal - stats.totalMovements - stats.patrimonyInitial) /
            stats.patrimonyInitial * 100);

        $('#totalStats').html(`
        <p>Patrimonio iniziale: ${stats.patrimonyInitial.toFixed(2)} €</p>
        <p>Patrimonio finale: ${stats.patrimonyFinal.toFixed(2)} €</p>
        <p>Totale movimenti: ${stats.totalMovements.toFixed(2)} €</p>
        <p>Gain/Loss totale: ${stats.totalGainLoss.toFixed(2)} €</p>
        <p>Rendimento totale: ${rendimentoTotale.toFixed(2)}%</p>
    `);

        const gainLossValues = stats.dailyGains.map(day => day.gainLoss);
        const mean = gainLossValues.reduce((a, b) => a + b, 0) / gainLossValues.length;
        const std = Math.sqrt(gainLossValues.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / gainLossValues.length);
        const positiveCount = gainLossValues.filter(v => v > 0).length;
        const negativeCount = gainLossValues.filter(v => v < 0).length;

        $('#additionalStats').html(`
        <p>Media gain/loss giornaliero: ${mean.toFixed(2)} €</p>
        <p>Deviazione standard gain/loss: ${std.toFixed(2)} €</p>
        <p>Giorni positivi: ${positiveCount}</p>
        <p>Giorni negativi: ${negativeCount}</p>
    `);

        updateChart(stats.dailyGains);
        $('#results').show();
    }

    $('#csvFile').change(async function (e) {
        const file = e.target.files[0];
        const data = await parseCSV(file);
        const alignedMovements = alignMovementDates(data.portfolioData, data.movimentiData);
        const stats = calculateStats(data.portfolioData, alignedMovements);
        displayResults(stats);
    });

    // Add resize handler
    window.addEventListener('resize', function () {
        if (chart) {
            chart.resize();
        }
    });
</script>
</body>
</html>
